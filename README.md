# MOSEC-2017

<p align="center">

<img src="Images/banner.jpg" alt="MOSEC" title="MOSEC"/>

</p>

第三届MOSEC移动安全技术峰会之旅

简单介绍下背景，**MOSEC** 是盘古团队和 **POC** 主办的移动安全技术峰会，到今年已经是第三届，虽然从影响力来看，不如一些重量级的黑客大会，比如 **Black Hat** 和 **DEFCon**，但是从这三届大会的参会者的反馈来看，会议的议题的质量都不错，聚焦移动安全领域前沿性的技术议题及发展趋势，再来看主办方，盘古实验室，相信大家都不陌生，是国内首个自主实现 iOS 完美越狱的团队，也是全球范围内第一个实现针对 iOS 8 和 iOS 9 系统完美越狱的团队。在主流操作系统和重要应用程序中曾发现过数百个0day安全漏洞，也多次在全球顶尖安全会议上分享，如 **Black Hat**, **Syscan** 等，**POC** 是韩国最大的安全技术峰会， 最初是2006年一群韩国黑客与安全研究专家决定以“交流技术、分享知识”为目的举办会议，并将其命名为 **POC**(Power of Community，社区力量)，它是目前互联网安全界举办历史最悠久的大会之一。再来看看会议议程，这届 **MOSEC** 盘古团队没有参与议题分享，只有主持人王铁磊是盘古团队的，王铁磊在去年 **Black Hat USA** 对盘古9实现的技术做过分享。本次与 iOS 平台相关的议题主要有三场，分别是上午的第二场议题：现代iOS系统溢出缓解机制，Speaker 是一位来自意大利年仅20岁的安全研究人员 Luca，喜欢破解各种设备，越狱工具 Yalu 的作者；下午的议题有 Lookout 公司的安全研究员 Max Bazaliy 带来的 Apple Watch 的越狱，Max Bazaliy 在 **Black Hat**、**DEFCon** 大会上进行过多次分享。最后一场也是重量级的嘉宾，是科恩实验室的安全研究员陈良，分享的议题是 iOS 10 内核安全漫谈。

## 致辞

这次 MOSEC 的主持人是王铁磊，关注 iOS 越狱领域的读者对他应该都不会陌生，他是盘古团队的首席科学家，还是上海犇众信息技术有限公司的联合创始人，多次在Blackhat、CanSecWest、PoC、XCon等业界安全峰会报告。

### 360
接下来是360的首席安全官谭晓生发言，介绍安全会议，办成精品会议，干货满满，希望与会嘉宾有所收获，网络安全火爆，也遇到很大的挑战，安全首先是要为业务服务，会遇到业务发展和安全的一个权衡。网络安全市场不到400亿，启明星辰20亿，不是一个爆发暴富的行业，沉浸在安全技术方向，网络安全攻防失衡，一家公司一个团队没有办法解决网络安全遇到的问题。

## Android应用签名的枷锁与革新

百度安全实验室，百度首席安全 Android 签名的痛，苦和未来，


### QA

百度以前签名是交由各产线管理，现在准备收回安全管理部门通过 **OASP** 平台进行管理。

## 现代iOS系统溢出缓解机制

<p align="center">

<img src="Images/luca.jpg" />

</p>

第二场议题是由年仅20岁的意大利天才黑客，Yalu 的作者 Luca Todesco 带来的现代iOS系统溢出缓解机制。

开场 Luca 简单介绍了自己，喜欢做安全研究相关的工作，在几个公开的 iOS 越狱工具都做了贡献，闲暇时间私下会越狱相关，包括最新版本 iOS 和 PS4。此外还提及他曾在 Twitter 上惹怒了一个德国人，他口中的德国人就是 Stefan Esser‏。

<p align="center">

<img src="Images/luca1.jpeg" />

</p>


Luca 介绍了 iOS 史前时期的安全机制，iPhone OS 1.0所有都在 root 权限下运行，没有代码签名和沙箱。通过混淆来加密 OS 镜像文件。在 iOS 5出现了用户态的 ASLR，iOS 6出现内核态的 ASLR，并且区分了用户和内核的地址空间。其中大部分的防护机制都是基于沙盒的。

现代 iOS 安全方面，有些利用缓解策略已经实现了，iOS 10 在安全方面取得胜利，比如对堆采取了一些强化措施来避免 zone confusion 和错误使用 kfree 的攻击。事实是：Apple 并没有主动推出利用缓解，他们只是等 Ian Beer 放出新的利用，然后做一些小的改动来使利用变得没什么作用。

### Code Integrity

#### Kernel

在内核层面，Apple 在 iOS 9 上首次启用了 KPP(Kernel Patch Protection)，不过仅限在 arm64 机器上，这是因为 KPP 需要借助64位机器上的安全芯片来实现。TrustZone 在 iOS 的具体实现，被非官方的称为 WatchTower，更通常的叫法是 KPP。iPhone 7使用硬件加强了保护，错误的被称为 AMCC，据传正确的名字应该是"SiDP"。

#### WebKit

JIT(Just-in-time)即时编译对于高效执行 JavaScript 代码是必要的，这种代码签名正常过于宽松，JIT 编译器会生成新的和未签名的代码。假设一名攻击者可以管理一个"write-anywhere"的攻击，那么也就意味着他能够执行任意代码。存储区被标记为读、写和执行权限，区分权限的方式可以有效杜绝利用数据区域执行代码的攻击，在 iOS 10 中 Apple 将编译 JavaScript 放在仅允许执行的存储区之中。任何进程都无法从这个区域读取和写入数据。

### Data Protection

Secure Enclave 是 Apple A7(iPhone 5s 使用的处理器)或更高版本 A 系列处理器中集成的协处理器。它是独立的安全加密模块，每个 Secure Enclave 在制造过程中都预置了 UID（唯一 ID），这个 ID 无法从系统的其他部分访问，而且就连 Apple 也没办法获取。

主要用于处理指纹相关的数据，保证用户的指纹信息不被任何第三方窃取。工作原理大致是 Secure Enclave 接收到来自 Touch ID 传感器的指纹数据，确认是否匹配，处理器和 Touch ID 传感器之间的通信通过串行外围接口总线实现。处理器将数据转发到 Secure Enclave，但处理器本身无法读取这些数据。


### The cold，hard truth

所有的安全策略最终都是无用的，"Bulletproof JIT" 可能是最好的缓解措施，尽管它现在没用，但是未来会比 KPP 更有意义。Secure Enclave 会使得加大攻击者的攻击成本，然而，以色列的移动设备取证公司 Cellebrite 已经支持 iPhone 设备的解锁和取证。

<p align="center">

<img src="Images/luca2.jpeg" />

</p>

### Attacks

#### WatchTower


### QA

没有问题

## 天空之城－飞控安全攻防剖析

### QA

没有问题

## Pwning苹果手表

### QA

没有问题

## 伤痕累累的Android Wi-Fi驱动 - 从本地提权到远程攻击

### QA

Q:没太听清楚，提问者问了大概是代码中的漏洞需不需通过一个工具来检测

A:不需要，基本上从代码审计的层面就可以发现出来

## 幻象之盒

### QA

没有问题

## iOS 10内核安全漫谈

会议开始时陈良提到虽然他曾做过多次 iOS 内核相关的分享，但本次是他第一次分享 iOS 10 内核安全。

2016年12月12日 iOS 10.2 发布，Google Project Zero 的 Ian Beer 在12月中旬发布 mach\_portal 利用，整个攻击链由三个漏洞组成，mach\_portal 利用的漏洞都源于 XNU 内核对 Mach Port 的处理不当，这也是 mach_portal 名称的由来。
Project Zero 是 Google 在2014年7月15日公开的一个信息安全团队，此团队专责找出各种软件的安全漏洞，特别是可能会导致0Day攻击者，他们找出安全漏洞之后，会即时通知受影响软件的开发者，在开发者还没修补此漏洞前，不会对外公布。但90天之后，无论原开发者是否已修复漏洞，都会自动公开。

Luca 发布了 iOS 10.1.1 的越狱工具，被称为“Yalu + mach\_portal”，就是基于前面提到的 Ian Beer 发现的 mach\_portal 攻击链，包含了iPhone 7 中绕过 AMCC，AMCC 据推测是 Apple Memory C…bla Controller 的简称，也有传言说正确的名字应该是”SiDP"。中间 C 不大清楚代表什么，是 iPhone 7 新引入的硬件保护机制，可以从硬件层面保证页不被篡改。
随后 Luca 和 Marco Grassi 在17年1月26号发布了半完美越狱工具 Yalu102。
17年3月27号 iOS 10.3 发布，从那儿以后，好像一切都风平浪静了。
问题：今年发生了什么？

接下来会从漏洞、机制、利用缓解三个方面漫谈iOS内核安全, 最后会进行总结。

先从盘古9.3.3开始说，漏洞的 CVE ID 是 CVE-2016-4654,简单介绍下 CVE，CVE 全称“Common Vulnerabilities&Exposures” 公共漏洞和暴露。CVE 为广泛认同或者已经暴露出来的信息安全漏洞的给出一个公共的名称，可以帮助用户在各个独立漏洞数据库中和漏洞评估工具中共享数据。如果有 CVE 的名称，就可以快速的在其他任何 CVE 兼容的数据库中找到对应的修补信息，方便解决安全问题。命名都会以 CVE 作为前缀，中间是年份，比如上面这个漏洞就是在2016年公开的，最后是4位的随机数，没有任何其他含义，只是一个编号，当数字全部用光后，可以增加数字的位数。
`IOMobileFrameBuffer` 是处理屏幕帧缓存的内核扩展，⽤户态通过**IOMobileFramebuffer.framework** 框架来控制，最终会调⽤ `IOMobileFramebuffer::swap_submit` 触发漏洞，`IOMFBSwap` 数据是用户可控（⽤户态传⼊），循环中没有检查 `v33` 长度，赋值 `v34` 的时候发⽣堆溢出。

### QA

Q：Luca 提问，问题的意思是为什么没有放出来详细案例。

A：主要是为了保护客户的隐私。

## 闭幕
在最后一个议题 KeenLab 结束后，蚂蚁金服负责人进行会议结语，总结了面向未来的安全展望，提出了安全在互联网领域会变得越来越重要，从前安全上出现问题，可能只是要了钱，
但是随着万物互联，未来安全出现问题，就很可能要了命。